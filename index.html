import pandas as pd
import dash
from dash import dcc, html, Input, Output, dash_table
import dash_bootstrap_components as dbc
import base64
import io

# Inicialização do app com tema profissional
app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])

# Layout do app
app.layout = dbc.Container([
    html.H2("Consulta de SLA", className="text-center mt-4"),
    
    dbc.Row([
        dbc.Col(dcc.Upload(
            id='upload-data',
            children=html.Button('Escolher arquivo', className='btn btn-secondary'),
            multiple=False
        ), width=4),
    ], className="mb-3 justify-content-center"),
    
    dbc.Row([
        dbc.Col(dcc.Input(id='input-login', type='text', placeholder='Digite o login', className="form-control"), width=3),
        dbc.Col(html.Button('Consultar', id='btn-consultar', className='btn btn-danger', n_clicks=0), width=2)
    ], className="mb-4 justify-content-center"),
    
    html.H4("Resultados:", className="mt-3"),
    html.Div(id='table-container')
])

# Callback para processar os dados
@app.callback(
    Output('table-container', 'children'),
    Input('upload-data', 'contents'),
    Input('input-login', 'value'),
    Input('btn-consultar', 'n_clicks')
)
def update_table(contents, login, n_clicks):
    if not contents or not login or n_clicks == 0:
        return ""
    
    # Decodificar o arquivo carregado
    content_type, content_string = contents.split(',')
    decoded = base64.b64decode(content_string)
    df = pd.read_excel(io.BytesIO(decoded), header=None)
    df.columns = ["RAL/REC", "Login", "Volume", "SLA"]
    
    # Filtrar pelo login
    df = df[df["Login"] == login]
    if df.empty:
        return html.Div("Nenhum dado encontrado para este login.", className="text-danger")
    
    # Definir resultado de SLA
    df["Resultado"] = df["SLA"].apply(lambda x: "Ganho" if x == 1 else "Perda")
    
    # Criar tabela estilizada
    table = dash_table.DataTable(
        columns=[
            {"name": "RAL/REC", "id": "RAL/REC"},
            {"name": "Resultado", "id": "Resultado"}
        ],
        data=df[["RAL/REC", "Resultado"]].to_dict('records'),
        style_data_conditional=[
            {"if": {"filter_query": '{Resultado} eq "Ganho"'}, "backgroundColor": "green", "color": "white"},
            {"if": {"filter_query": '{Resultado} eq "Perda"'}, "backgroundColor": "red", "color": "white"}
        ],
        style_table={'overflowX': 'auto'},
        style_header={"backgroundColor": "#f8f9fa", "fontWeight": "bold"}
    )
    
    return table

# Rodar o app
if __name__ == '__main__':
    app.run_server(debug=True)
