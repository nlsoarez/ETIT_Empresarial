<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel SLA - Consulta por Matrícula</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      color: #e60000;
      text-align: center;
      margin-bottom: 20px;
    }
    .input-group {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, button, select {
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #e60000;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #c50000;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1;
    }
    .resultado-box {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .sla-dentro {
      color: #2ecc71;
      font-weight: bold;
    }
    .sla-fora {
      color: #e74c3c;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    tr:hover {
      background-color: #f0f0f0;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #e60000;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .filtros {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filtro-item {
      flex: 1;
      min-width: 200px;
    }
    .resumo {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f8f8;
      border-radius: 4px;
    }
    .resumo-item {
      text-align: center;
      flex: 1;
    }
    .resumo-valor {
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Painel de Consulta SLA - ETIT Residencial</h1>

    <div class="input-group">
      <div>
        <label for="arquivoExcel">Selecione o arquivo Excel:</label>
        <input type="file" id="arquivoExcel" accept=".xlsx,.xls" />
      </div>
      <div>
        <label for="matricula">Matrícula:</label>
        <input type="text" id="matricula" placeholder="Digite a matrícula" />
      </div>
      <button id="btnConsultar" onclick="consultar()">Consultar Todos os Tickets</button>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Processando arquivo...</p>
    </div>

    <div id="resultadosContainer">
      <div id="filtrosContainer" class="filtros" style="display: none;">
        <div class="filtro-item">
          <label for="filtroTipo">Filtrar por Tipo:</label>
          <select id="filtroTipo" onchange="filtrarTickets()">
            <option value="todos">Todos</option>
            <option value="RAL">RAL</option>
            <option value="REC">REC</option>
          </select>
        </div>
        <div class="filtro-item">
          <label for="filtroSLA">Filtrar por SLA:</label>
          <select id="filtroSLA" onchange="filtrarTickets()">
            <option value="todos">Todos</option>
            <option value="dentro">Dentro do SLA</option>
            <option value="fora">Fora do SLA</option>
          </select>
        </div>
      </div>

      <div id="resumoContainer" class="resumo" style="display: none;"></div>

      <div id="ticketsContainer" class="resultado-box" style="display: none;">
        <table id="ticketsTable">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>Tipo</th>
              <th>Tempo</th>
              <th>SLA</th>
              <th>Matrícula</th>
              <th>Abertura</th>
              <th>Encerramento</th>
            </tr>
          </thead>
          <tbody id="ticketsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let todosTickets = [];
    let ticketsFiltrados = [];

    // Habilita/desabilita botão conforme seleção de arquivo e matrícula
    document.getElementById('arquivoExcel').addEventListener('change', validarEntradas);
    document.getElementById('matricula').addEventListener('input', validarEntradas);

    function validarEntradas() {
      const arquivoSelecionado = document.getElementById('arquivoExcel').files.length > 0;
      const matriculaPreenchida = document.getElementById('matricula').value.trim() !== '';
      
      document.getElementById('btnConsultar').disabled = !(arquivoSelecionado && matriculaPreenchida);
    }

    function consultar() {
      const fileInput = document.getElementById("arquivoExcel");
      const matricula = document.getElementById("matricula").value.trim();

      if (!fileInput.files.length) {
        alert("Selecione um arquivo para continuar.");
        return;
      }

      if (!matricula) {
        alert("Digite a matrícula para consultar.");
        return;
      }

      document.getElementById("loading").style.display = "block";
      document.getElementById("btnConsultar").disabled = true;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const dados = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (dados.length === 0 || dados[0].length < 5) {
            alert("Formato de planilha inválido. Verifique se o arquivo contém todas as colunas necessárias.");
            return;
          }

          // Filtra por matrícula e processa os tickets
          todosTickets = dados
            .filter(row => row[1] && row[1].toString().includes(matricula))
            .map(row => {
              const tipo = row[0] ? (row[0].toString().startsWith("RAL") ? "RAL" : 
                                    row[0].toString().startsWith("REC") ? "REC" : "OUTRO") : "OUTRO";
              
              let tempoMinutos = 0;
              let dentroSLA = false;
              
              if (row[2] && row[3]) {
                try {
                  const abertura = new Date(row[2]);
                  const encerramento = new Date(row[3]);
                  
                  if (!isNaN(abertura.getTime()) && !isNaN(encerramento.getTime())) {
                    tempoMinutos = (encerramento - abertura) / (1000 * 60);
                    dentroSLA = tempoMinutos <= 1440; // 24 horas em minutos
                  }
                } catch (e) {
                  console.warn("Erro ao processar datas do ticket:", row, e);
                }
              }
              
              return {
                ticket: row[0] || '',
                tipo: tipo,
                tempo: tempoMinutos,
                sla: dentroSLA ? "Dentro" : "Fora",
                matricula: row[1] || '',
                abertura: row[2] || '',
                encerramento: row[3] || '',
                descricao: row[4] || ''
              };
            });

          // Mostra os controles de filtro
          document.getElementById("filtrosContainer").style.display = "flex";
          document.getElementById("ticketsContainer").style.display = "block";
          
          // Exibe todos os tickets inicialmente
          ticketsFiltrados = [...todosTickets];
          atualizarTabela();
          atualizarResumo();

        } catch (error) {
          console.error("Erro ao processar arquivo:", error);
          alert("Ocorreu um erro ao processar o arquivo.");
        } finally {
          document.getElementById("loading").style.display = "none";
          document.getElementById("btnConsultar").disabled = false;
        }
      };

      reader.onerror = function() {
        alert("Erro ao ler o arquivo. Por favor, tente novamente.");
        document.getElementById("loading").style.display = "none";
        document.getElementById("btnConsultar").disabled = false;
      };

      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function filtrarTickets() {
      const tipo = document.getElementById("filtroTipo").value;
      const sla = document.getElementById("filtroSLA").value;

      ticketsFiltrados = todosTickets.filter(ticket => {
        // Filtro por tipo
        if (tipo !== 'todos' && ticket.tipo !== tipo) return false;
        
        // Filtro por SLA
        if (sla !== 'todos') {
          if (sla === 'dentro' && ticket.sla !== 'Dentro') return false;
          if (sla === 'fora' && ticket.sla !== 'Fora') return false;
        }
        
        return true;
      });

      atualizarTabela();
    }

    function atualizarTabela() {
      const tbody = document.getElementById("ticketsBody");
      tbody.innerHTML = '';

      ticketsFiltrados.forEach(ticket => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${ticket.ticket}</td>
          <td>${ticket.tipo}</td>
          <td>${formatarTempo(ticket.tempo)}</td>
          <td class="${ticket.sla === 'Dentro' ? 'sla-dentro' : 'sla-fora'}">${ticket.sla}</td>
          <td>${ticket.matricula}</td>
          <td>${formatarData(ticket.abertura)}</td>
          <td>${formatarData(ticket.encerramento)}</td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    function atualizarResumo() {
      const resumoContainer = document.getElementById("resumoContainer");
      resumoContainer.style.display = "flex";
      
      const total = todosTickets.length;
      const totalRAL = todosTickets.filter(t => t.tipo === 'RAL').length;
      const totalREC = todosTickets.filter(t => t.tipo === 'REC').length;
      const dentroSLA = todosTickets.filter(t => t.sla === 'Dentro').length;
      const foraSLA = todosTickets.filter(t => t.sla === 'Fora').length;
      
      resumoContainer.innerHTML = `
        <div class="resumo-item">
          <div class="resumo-valor">${total}</div>
          <div>Total de Tickets</div>
        </div>
        <div class="resumo-item">
          <div class="resumo-valor">${totalRAL}</div>
          <div>Tickets RAL</div>
        </div>
        <div class="resumo-item">
          <div class="resumo-valor">${totalREC}</div>
          <div>Tickets REC</div>
        </div>
        <div class="resumo-item">
          <div class="resumo-valor sla-dentro">${dentroSLA}</div>
          <div>Dentro do SLA</div>
        </div>
        <div class="resumo-item">
          <div class="resumo-valor sla-fora">${foraSLA}</div>
          <div>Fora do SLA</div>
        </div>
      `;
    }

    function formatarData(dataString) {
      if (!dataString) return '';
      try {
        const date = new Date(dataString);
        if (isNaN(date.getTime())) return dataString;
        return date.toLocaleString('pt-BR');
      } catch {
        return dataString;
      }
    }

    function formatarTempo(minutos) {
      if (minutos < 1) return '0 min';
      if (minutos < 60) return `${Math.round(minutos)} min`;
      if (minutos < 1440) {
        const horas = Math.floor(minutos / 60);
        const mins = Math.round(minutos % 60);
        return `${horas}h ${mins}m`;
      }
      const dias = Math.floor(minutos / 1440);
      const horas = Math.floor((minutos % 1440) / 60);
      return `${dias}d ${horas}h`;
    }
  </script>
</body>
</html>
